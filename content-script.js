let API_KEY = "";
chrome.storage.local.get('apiKey', function (result) {
	API_KEY = result.apiKey;
});
let isMobile = location.hostname == "m.youtube.com";
// start with "/shorts"
let isShorts = () => location.pathname.startsWith("/shorts"); 
let isNormalVideo = () => location.pathname.startsWith("/watch");

// debug variables print to console
const clogCentroids = false;
const clogDistanceWeights = false;
const clogCoordinateStats = false;
const clogCorruptedCentroids = false;
const clogObsoleteCentroids = false;
const clogClusteringInfo = false;
const clogVideoIds = false;
// export variables 
const exportVariables = false;

// #region get data from chrome storage
async function getCentroids(datapoint) {
	datapointDeepCopy = JSON.parse(JSON.stringify(datapoint));
	let centroids = await new Promise((resolve, reject) => {
		chrome.storage.local.get('centroids', function (result) {
			if (result.centroids) {
				resolve(result.centroids);
			} else { // if no centroids are stored
				let backup = [{"age":40192,"averageDistance":0.31590783020345303,"averageLikesToViewsRatio":0.06396007295638327,"averageViews":1033047.0793494357,"coordinates":[0.25611952971650187,-0.05082464263499057,0.2177071760368948,-0.08772377629623392,0.17284714707984436,0.3796557055197212,-0.23688273599306017,0.1313276802403018,-0.09302642622943073,0.13988842275948296,-0.1688655552691897,-0.052544856018745714,-1.5465890399328734,-0.06250499091122112],"count":2029,"countAgeRatio":0.050482683121019105,"meanSquaredDifferenceDistance":140.5620000704,"meanSquaredDifferenceLikesToViewsRatio":10.235888339853199,"varianceDistance":0.06931065092228797,"varianceLikesToViewsRatio":0.005047282218862524},{"age":40188,"averageDistance":0.3526532192508656,"averageLikesToViewsRatio":0.04712644936367906,"averageViews":2210136.905600004,"coordinates":[0.3184707441713747,-0.03322833323450052,0.27971101398382187,-0.07859999877100632,0.2533274644678807,0.3084932276829926,-0.1759816344918134,0.12382909818128696,-0.01005115837121886,0.2502355777478738,-0.11970155089461833,0.004054574863455614,-2.6028648484852885,-0.03050339543767675],"count":3125,"countAgeRatio":0.0777595302080223,"meanSquaredDifferenceDistance":414.65624699284996,"meanSquaredDifferenceLikesToViewsRatio":5.256615856358232,"varianceDistance":0.13273247342920932,"varianceLikesToViewsRatio":0.001682655523802251},{"age":36070,"averageDistance":0.2869071959662893,"averageLikesToViewsRatio":0.007923699355583402,"averageViews":1696559.0170316293,"coordinates":[0.21524417571582324,-0.06081627201670626,0.23086077632487925,-0.16811962226927732,0.23886700378561546,1.103960567525174,1.8687696958608755,0.13023576937024295,-0.26465866056393295,0.2001999966902404,-0.3070944794404212,-0.011192751135808521,-1.8779761822897392,-0.03307948740504484],"count":822,"countAgeRatio":0.022789021347380093,"meanSquaredDifferenceDistance":59.595992626816866,"meanSquaredDifferenceLikesToViewsRatio":0.07004503475507762,"varianceDistance":0.07258951598881469,"varianceLikesToViewsRatio":0.00008531672929972914},{"age":33370,"averageDistance":0.17144098326549517,"averageLikesToViewsRatio":0.05038481913963254,"averageViews":1083239.3382030665,"coordinates":[0.42730736002307096,-0.06726017045324358,0.39779570937574077,-0.14627194458983853,0.4083018572864837,0.08210652724790775,-0.5146515092369321,0.15162898028654925,-0.08117461028345402,0.3944585814287363,-0.24518513561973873,0.045420686583338324,-0.3314576220696615,-0.027855180376918212],"count":1369,"countAgeRatio":0.0410248726400959,"meanSquaredDifferenceDistance":26.04330700033704,"meanSquaredDifferenceLikesToViewsRatio":0.9872139108379732,"varianceDistance":0.01903750511720544,"varianceLikesToViewsRatio":0.0007216475956417932},{"age":30960,"averageDistance":0.1962472947340537,"averageLikesToViewsRatio":0.04390027199403536,"averageViews":1159452.9464856233,"coordinates":[0.3405150855490298,-0.04497382294478175,0.2825556327105721,-0.09773758633175382,0.2521473767000095,0.16680146504403986,-0.45704841519718487,0.12974284309317943,-0.08464958244407828,0.27111814497180764,-0.18061868901013076,-0.014757082811834016,-5.505786619080074,-0.03473768066067144],"count":1252,"countAgeRatio":0.040439276485788114,"meanSquaredDifferenceDistance":36.98195280468471,"meanSquaredDifferenceLikesToViewsRatio":0.8923467141121482,"varianceDistance":0.029561912713576905,"varianceLikesToViewsRatio":0.0007133067259089914},{"age":27782,"averageDistance":0.25743046255181495,"averageLikesToViewsRatio":0.02887686569481105,"averageViews":2593487.770281126,"coordinates":[0.3181898994055898,-0.039044446490536094,0.24987501773629053,-0.09371970559106475,0.2435757803866621,0.633622975935505,0.24852428928486398,0.1343130339960708,-0.04040627968434694,0.27102538040669283,-0.15590892581966168,-0.013819230769542348,-5.266895965891976,-0.03648556955585849],"count":1245,"countAgeRatio":0.044813188395363905,"meanSquaredDifferenceDistance":69.6185738440721,"meanSquaredDifferenceLikesToViewsRatio":0.42168234688116846,"varianceDistance":0.055963483797485614,"varianceLikesToViewsRatio":0.0003389729476536724},{"age":27718,"averageDistance":0.42505930215082915,"averageLikesToViewsRatio":0.06502292643441718,"averageViews":566108.7243502052,"coordinates":[0.23938632660669676,-0.05087212633423869,0.1913108847879473,-0.09796907767654724,0.2396657917744028,-0.845037652366384,-0.6329220096708967,0.10301219929728095,-0.0792725343589044,0.27402774458569457,-0.15287999231417823,-0.03186229801991742,-12.661192421111556,-0.037195666375858555],"count":1462,"countAgeRatio":0.052745508333934626,"meanSquaredDifferenceDistance":220.7841310917833,"meanSquaredDifferenceLikesToViewsRatio":6.262015383614877,"varianceDistance":0.15111850177397898,"varianceLikesToViewsRatio":0.004286115936765829},{"age":27308,"averageDistance":0.33674214106630324,"averageLikesToViewsRatio":0.06837168839775765,"averageViews":328162.0247252748,"coordinates":[0.2601131856752254,-0.05357842627935272,0.1744576460077382,-0.10108047768815875,0.2483727489658794,-1.2058053738745573,-0.7307925933078109,0.10685719133250389,0.0844272932520107,0.2700332992905435,-0.17342905901359912,-0.03914001644382431,-9.326084557499895,-0.03710757847392206],"count":728,"countAgeRatio":0.02665885454811777,"meanSquaredDifferenceDistance":53.75313011210797,"meanSquaredDifferenceLikesToViewsRatio":1.7642654746805375,"varianceDistance":0.07393828075943325,"varianceLikesToViewsRatio":0.002426775068336365},{"age":25485,"averageDistance":0.2515345459405885,"averageLikesToViewsRatio":0.051421793000926336,"averageViews":886228.4452149794,"coordinates":[0.2608431952681876,-0.03945465366261773,0.20542756559718633,-0.08906952342791555,0.22529182817281942,0.1044316064483368,-0.46060894391653107,0.10888610343642743,-0.09914781450463202,0.22043766274802754,-0.2065048711581285,0.005702098705925536,-4.07924685175924,-0.029554471268114942],"count":1442,"countAgeRatio":0.05658230331567589,"meanSquaredDifferenceDistance":70.35219738564241,"meanSquaredDifferenceLikesToViewsRatio":7.796828405465836,"varianceDistance":0.048821788609050946,"varianceLikesToViewsRatio":0.005410706735229588},{"age":25075,"averageDistance":0.7579612086319921,"averageLikesToViewsRatio":0.29425579333835916,"averageViews":1302586.291666665,"coordinates":[0.16406193831434304,0.004896162947772713,0.18438992126689746,-0.09469146700284052,0.24067506876930023,-0.9849273044437398,-0.5727899305824022,0.03169199687632352,-0.1150874528657537,0.21355148029437462,-0.04883105119642788,-0.03329990847579803,-24.56091797370908,-0.03699854335251421],"count":528,"countAgeRatio":0.0210568295114656,"meanSquaredDifferenceDistance":426.5243040413049,"meanSquaredDifferenceLikesToViewsRatio":3072.7995607738108,"varianceDistance":0.8093440304389087,"varianceLikesToViewsRatio":5.830739204504384},{"age":23695,"averageDistance":0.2831952736938276,"averageLikesToViewsRatio":0.030522633707930083,"averageViews":4138565.805477532,"coordinates":[0.39857662812390765,-0.011126087701420182,0.3647785790199899,-0.07742119706645367,0.23291867583932827,0.8940860571254761,0.8856308771180958,0.0825998542422065,-0.10466425835866093,0.3764795677887562,0.4338644128705467,-0.04692075519717732,-3.377984695992727,-0.03607850555343173],"count":1424,"countAgeRatio":0.06009706689174931,"meanSquaredDifferenceDistance":71.63752748333249,"meanSquaredDifferenceLikesToViewsRatio":0.5190485220599887,"varianceDistance":0.05034260539939037,"varianceLikesToViewsRatio":0.00036475651585382205},{"age":20622,"averageDistance":0.3768986858147072,"averageLikesToViewsRatio":0.06050713974961298,"averageViews":974756.1029850747,"coordinates":[0.2592148042565586,-0.04871259112799929,0.19250564507394405,-0.09147618717323835,0.22655632414351318,0.6340115394221207,0.41451970667349436,0.11785947259648465,-0.11181621077876908,0.26667451620735094,-0.20679133053354093,-0.03515390230493503,-9.250265376734296,-0.03566984663517148],"count":670,"countAgeRatio":0.032489574241101736,"meanSquaredDifferenceDistance":46.29860413664102,"meanSquaredDifferenceLikesToViewsRatio":359.68346024969827,"varianceDistance":0.06920568630290137,"varianceLikesToViewsRatio":0.5376434383403561},{"age":19956,"averageDistance":0.36136903007627896,"averageLikesToViewsRatio":0.044280606288712665,"averageViews":1155188.2254150708,"coordinates":[0.23109042947902167,-0.046631844620277044,0.18582414498351096,-0.0871168497111774,0.21742050382094372,0.09431834622725295,-0.2667218576993673,0.11095063081978061,-0.041765545519167356,0.21072598923488128,-0.21036345196699682,0.0878530548049601,-6.369451625663312,-0.022752553839377552],"count":1566,"countAgeRatio":0.07847263980757667,"meanSquaredDifferenceDistance":245.3164006412909,"meanSquaredDifferenceLikesToViewsRatio":2.8092084496208134,"varianceDistance":0.15675169370050537,"varianceLikesToViewsRatio":0.0017950213735596252},{"age":18256,"averageDistance":0.3590912828401603,"averageLikesToViewsRatio":0.07123039390255509,"averageViews":264227.9431616344,"coordinates":[0.12830969998326136,-0.04936112375034017,0.14632671163537356,-0.08867315097073235,0.21563954947630884,-1.0340061941106868,-0.5910974644101884,0.013687625477951581,-0.04535505622511881,0.16340609026049588,-0.233511731817068,0.04600113919964806,-4.405534189645209,-0.030446307141975246],"count":563,"countAgeRatio":0.03083917616126205,"meanSquaredDifferenceDistance":63.46734466387569,"meanSquaredDifferenceLikesToViewsRatio":2.3298319289863385,"varianceDistance":0.11293121826312401,"varianceLikesToViewsRatio":0.004145608414566439},{"age":17842,"averageDistance":0.982541746586323,"averageLikesToViewsRatio":0.07374778708569392,"averageViews":397983.6876971611,"coordinates":[0.059577741212997276,-0.038471644584799986,0.13629163188900012,-0.09060023567178006,0.22270696145729396,-1.0419976542868985,-0.6536393165216011,0.09080919031119829,-0.1131099147167313,0.21741220096110242,-0.1086200937368322,-0.031081064717269995,-34.08080187605778,-0.03441676539023105],"count":317,"countAgeRatio":0.01776706647236857,"meanSquaredDifferenceDistance":293.158443739859,"meanSquaredDifferenceLikesToViewsRatio":1.3646170928687194,"varianceDistance":0.927716594113478,"varianceLikesToViewsRatio":0.004318408521736454},{"age":17803,"averageDistance":0.5047535166591421,"averageLikesToViewsRatio":0.11328344301118669,"averageViews":820634.6179921762,"coordinates":[0.14033038412424226,-0.04482931521523272,0.177184667968885,-0.08837933259706468,0.22028359954983026,-0.7525023387762396,-0.5991697012320524,0.0431785421667045,-0.12244352985153607,0.25118789684682824,-0.12606399423568304,-0.020167829365963327,-15.364469438594218,-0.029729443706934706],"count":767,"countAgeRatio":0.04308262652361961,"meanSquaredDifferenceDistance":194.30250948347964,"meanSquaredDifferenceLikesToViewsRatio":1313.4943013533855,"varianceDistance":0.2536586285685113,"varianceLikesToViewsRatio":1.7147445187381012},{"age":16965,"averageDistance":0.25216765921153367,"averageLikesToViewsRatio":0.03913270761954589,"averageViews":1426952.8596026488,"coordinates":[0.3188538457222569,-0.044012276512028166,0.23639669062684918,-0.08437772532158669,0.21288354274556195,0.21663682989021582,-0.36008265281798374,0.12176853376788749,-0.08390171706396121,0.23049406987361554,-0.20386056283510304,0.057694921780862315,-7.801317469440004,-0.03427277858209716],"count":755,"countAgeRatio":0.044503389330975536,"meanSquaredDifferenceDistance":43.82403225967966,"meanSquaredDifferenceLikesToViewsRatio":0.4033263225532755,"varianceDistance":0.0581220586998404,"varianceLikesToViewsRatio":0.0005349155471528852},{"age":15629,"averageDistance":0.7313151480965292,"averageLikesToViewsRatio":0.6895355378773554,"averageViews":9403085.845333343,"coordinates":[0.27464867666130405,-0.006597734100779033,0.19877995683419897,-0.05077619011614088,0.21814863043026123,-0.5573062830391617,-0.4236482163473292,0.08313874675172553,-0.13794966218024468,0.24885516072351926,-0.06478595355657708,0.15799270655169487,-23.229818859521984,-0.036154477254197896],"count":375,"countAgeRatio":0.02399385757246145,"meanSquaredDifferenceDistance":143.75925814506843,"meanSquaredDifferenceLikesToViewsRatio":26298.19745197481,"varianceDistance":0.38438304316863214,"varianceLikesToViewsRatio":70.31603596784709},{"age":15391,"averageDistance":0.40757481833971315,"averageLikesToViewsRatio":0.07147846906785468,"averageViews":5825980.631067965,"coordinates":[0.2895525504113886,-0.0006582572490638661,0.25023138477205176,-0.06585171457396094,0.2200694554598171,-0.7773485961174964,-0.589403877523588,0.08043746319667677,-0.15426512463612999,0.28551398244004916,0.08991022153738336,0.05765082400982386,-17.957602232441037,-0.03729076640179761],"count":309,"countAgeRatio":0.020076668182704177,"meanSquaredDifferenceDistance":30.843578417374584,"meanSquaredDifferenceLikesToViewsRatio":1.1752532120227284,"varianceDistance":0.1001414883680993,"varianceLikesToViewsRatio":0.0038157571818919754},{"age":15229,"averageDistance":0.2893988928547411,"averageLikesToViewsRatio":0.04608036883912312,"averageViews":6179927.02465753,"coordinates":[0.3307872036929939,-0.024100848868425517,0.23317786137196492,-0.06429470817944574,0.2162090854569951,-0.2885959917117304,-0.4591949116480711,0.10174152316975765,-0.13364930891538654,0.2611838010967178,-0.08103370251799014,0.05022463461669188,-11.168750795943776,-0.03641030974198779],"count":365,"countAgeRatio":0.02396743056011557,"meanSquaredDifferenceDistance":18.480572594673436,"meanSquaredDifferenceLikesToViewsRatio":0.4276584348486944,"varianceDistance":0.05077080383152043,"varianceLikesToViewsRatio":0.0011748858100238857},{"age":15187,"averageDistance":0.5762744776712819,"averageLikesToViewsRatio":0.03975641128315874,"averageViews":15321507.851318935,"coordinates":[0.1790376258267563,-0.0038291925372446528,0.24288169468290807,-0.024749744349319456,0.21546224070251163,0.05511962810450167,-0.2186077266517206,0.12744658109737225,-0.032883936347534864,0.2262198697665327,-0.09183871901327616,0.4294526530459979,-8.44227795033647,-0.02628925180543168],"count":417,"countAgeRatio":0.027457694080463554,"meanSquaredDifferenceDistance":92.87613514722277,"meanSquaredDifferenceLikesToViewsRatio":0.6326596040070275,"varianceDistance":0.22325994025774704,"varianceLikesToViewsRatio":0.0015208163557861238},{"age":14346,"averageDistance":0.6263998881834508,"averageLikesToViewsRatio":0.05097889667032018,"averageViews":1834330.536496349,"coordinates":[0.2734526689274991,-0.026621581723190763,0.21911812349279938,-0.0820904616164083,0.21054326155233966,-0.14470461545843277,-0.33891277547148063,0.125103217951056,-0.01695835099284935,0.2303676862929598,-0.10325359863432025,0.2579904797828189,-16.60515115420573,-0.03484867512914363],"count":274,"countAgeRatio":0.019099400529764395,"meanSquaredDifferenceDistance":92.48919894117182,"meanSquaredDifferenceLikesToViewsRatio":0.672747834221131,"varianceDistance":0.3387882745097869,"varianceLikesToViewsRatio":0.002464277781029784},{"age":13260,"averageDistance":0.2741478572098711,"averageLikesToViewsRatio":0.09457074395854137,"averageViews":25008.09585492227,"coordinates":[0.10656460312157523,-0.051727102334494575,0.08189576929395778,-0.08913582764336238,0.2166978201323261,-1.6047338343233293,-0.6993437061630944,0.06164531297675635,-0.12745209775581995,0.2072561809092901,-0.21245902558491694,-0.02448091581858798,-5.7478623236517565,-0.03407841257803489],"count":386,"countAgeRatio":0.029110105580693817,"meanSquaredDifferenceDistance":19.6365313228775,"meanSquaredDifferenceLikesToViewsRatio":1.5710396462681107,"varianceDistance":0.05100397746201948,"varianceLikesToViewsRatio":0.004080622457839248},{"age":12976,"averageDistance":0.8947196608739639,"averageLikesToViewsRatio":0.06485564718180412,"averageViews":231141.74208144803,"coordinates":[0.03340918947033492,-0.050369938537785514,0.13470109910675804,-0.08816529857889664,0.21011875231932556,-0.9189601981964305,-0.590694915235087,0.0434542217370498,-0.05684859992643046,0.24234819024036636,-0.15089291976980929,-0.002592390426220771,-28.089886800469902,-0.035618640981316375],"count":221,"countAgeRatio":0.017031442663378544,"meanSquaredDifferenceDistance":278.01872379528754,"meanSquaredDifferenceLikesToViewsRatio":0.8043010552023455,"varianceDistance":1.2637214717967615,"varianceLikesToViewsRatio":0.003655913887283389},{"age":12822,"averageDistance":0.3713270881237137,"averageLikesToViewsRatio":0.08279739043355054,"averageViews":508910.05750798754,"coordinates":[-0.003278474984942604,-0.04857369777217858,0.09387300113695195,-0.08653033506629694,0.21255748130489144,-1.2809503284693087,-0.6090951963220144,0.09173910025249155,-0.0595808846576948,0.1975294368501386,-0.21234893350295092,0.0288039834727768,-7.34756921236136,-0.03503749828580048],"count":313,"countAgeRatio":0.02441116830447668,"meanSquaredDifferenceDistance":28.713174388527126,"meanSquaredDifferenceLikesToViewsRatio":0.8615677388283635,"varianceDistance":0.09202940509143309,"varianceLikesToViewsRatio":0.0027614350603473187},{"age":10913,"averageDistance":0.3972383089560617,"averageLikesToViewsRatio":0.05186396225460547,"averageViews":3040423.4013157873,"coordinates":[0.0750990186321359,-0.048758513007238824,0.1333972240209726,-0.07425615433646753,0.19995214956960813,-0.10281220644576311,-0.4508468612238813,0.03799173121216919,-0.09225026122126813,0.2130537664236039,-0.2029200340469195,0.02081344777573304,-10.565266042326009,-0.03356776900274318],"count":304,"countAgeRatio":0.027856684687986806,"meanSquaredDifferenceDistance":39.877169287207444,"meanSquaredDifferenceLikesToViewsRatio":0.6288180655473493,"varianceDistance":0.13160781942972755,"varianceLikesToViewsRatio":0.0020753071470209546},{"age":10252,"averageDistance":0.838833575986595,"averageLikesToViewsRatio":0.037269001770194946,"averageViews":2778893.5,"coordinates":[-0.05585046675625766,-0.03284749261236507,0.2445548267812463,-0.07291734009004744,0.20906274414307457,0.18117974963634856,0.2654262025619938,0.08312701900280506,0.10547721561523864,0.12745982415105903,-0.1760347084217717,1.117547694153502,-4.355953368886432,0.00822696270099651],"count":160,"countAgeRatio":0.015606710885680842,"meanSquaredDifferenceDistance":55.975762676785976,"meanSquaredDifferenceLikesToViewsRatio":0.3576536368088639,"varianceDistance":0.3520488218665785,"varianceLikesToViewsRatio":0.002249393942194113},{"age":9015,"averageDistance":0.16319214132624668,"averageLikesToViewsRatio":0.02917042139273757,"averageViews":1082153.993630573,"coordinates":[0.2922624087180094,-0.043678983988676805,0.17092929761803385,-0.08146228997008931,0.19963658315498825,0.6715429034042618,-0.023263994585077444,0.14527254770156411,-0.07834116757396804,0.23320507210752686,-0.21829934317253644,-0.013415873397381999,-7.130511629194035,-0.03432890306410426],"count":471,"countAgeRatio":0.052246256239600664,"meanSquaredDifferenceDistance":10.364800952069718,"meanSquaredDifferenceLikesToViewsRatio":0.07158008174323807,"varianceDistance":0.02205276798312706,"varianceLikesToViewsRatio":0.00015229804626220867},{"age":8200,"averageDistance":0.562102927089182,"averageLikesToViewsRatio":0.06401455396369063,"averageViews":182066.26315789475,"coordinates":[-0.13276760271426416,-0.05028662017725887,0.11444925738913293,-0.0866063618263798,0.19983241545547745,-0.6154846424780509,-0.6061280803089061,0.11619102952029993,-0.07346664739931345,0.2254676666780677,-0.17069494877229321,-0.03353889015577334,-19.372551468781822,-0.03405022508893858],"count":133,"countAgeRatio":0.016219512195121952,"meanSquaredDifferenceDistance":26.326370286626783,"meanSquaredDifferenceLikesToViewsRatio":0.29576245275308755,"varianceDistance":0.199442199141112,"varianceLikesToViewsRatio":0.0022406246420688452},{"age":6300,"averageDistance":0.18873271898878793,"averageLikesToViewsRatio":0.026341514950756904,"averageViews":591459.5205047322,"coordinates":[0.3315248315263853,-0.04133472226766306,0.253532136780332,-0.07853773386287888,0.19817284482137615,1.1438016416127692,2.1595829066538217,0.038444760292205,-0.18238099895785256,0.25363556145898714,-0.1552600677353787,-0.009521481844113529,-3.4753258276836947,-0.03318620847810904],"count":634,"countAgeRatio":0.10063492063492063,"meanSquaredDifferenceDistance":30.55704329622315,"meanSquaredDifferenceLikesToViewsRatio":0.10533567674720629,"varianceDistance":0.04827337013621351,"varianceLikesToViewsRatio":0.00016640707227046807},{"age":4143,"averageDistance":0.09314865094298665,"averageLikesToViewsRatio":0.07177537342498502,"averageViews":3936156.366666666,"coordinates":[0.4183812610251019,0.01134195370376938,0.3698964926564604,-0.06061726330619552,0.19452913646608527,0.3375812838177685,-0.4972205417540366,0.15982198601186182,-0.09920523323202439,0.4716592400604594,7.170408697488444,-0.05595137869422839,-3.5226919670821686,-0.033629156967730896],"count":150,"countAgeRatio":0.036205648081100654,"meanSquaredDifferenceDistance":0.16020610018380577,"meanSquaredDifferenceLikesToViewsRatio":0.030285740707138468,"varianceDistance":0.0010752087260658106,"varianceLikesToViewsRatio":0.00020326000474589576},{"age":3981,"averageDistance":1.1565527429711713,"averageLikesToViewsRatio":0.008370212568148246,"averageViews":935112026.7760001,"coordinates":[-0.7555381540893967,1.6946391326963828,0.6011976815997491,3.9043071352236365,0.19927432824702027,1.042430298912227,1.3706365836600432,0.054856122880267144,-0.18454389848575262,0.38022162695779266,1.1500915767649451,0.4702699991423959,-3.094948285690877,-0.03354191196425363],"count":125,"countAgeRatio":0.031399145943230344,"meanSquaredDifferenceDistance":28.18098193617171,"meanSquaredDifferenceLikesToViewsRatio":0.01906772966528254,"varianceDistance":0.22726598335622347,"varianceLikesToViewsRatio":0.0001537720134296979},{"age":3621,"averageDistance":0.5203374555484143,"averageLikesToViewsRatio":0.039171745531506305,"averageViews":2618045.52631579,"coordinates":[0.09320761441797827,-0.0419933423374896,0.19584475955437627,-0.0818199042841812,0.19091076651229597,0.38749672657720613,0.07433861224171018,0.1341513648072577,-0.06960877861164541,0.1340422622159715,-0.1999568948662903,0.05137906655718926,-17.922654231456086,-0.029324902166252782],"count":76,"countAgeRatio":0.020988677161005248,"meanSquaredDifferenceDistance":15.781915093244573,"meanSquaredDifferenceLikesToViewsRatio":0.19902861866690577,"varianceDistance":0.2104255345765943,"varianceLikesToViewsRatio":0.0026537149155587436},{"age":3530,"averageDistance":0.9565587166042545,"averageLikesToViewsRatio":0.0837520510603499,"averageViews":21894.156862745083,"coordinates":[-2.810970473410019,-0.05937170129895381,-0.07478590298596641,-0.09359679057872103,0.1926810636478536,-1.5237498757623433,-0.6544273474388946,-0.674249821504454,0.06648873221480436,0.17632471293728086,-0.2084775935785539,0.0041296166060814776,-10.293720684830921,-0.03164686903523003],"count":51,"countAgeRatio":0.014447592067988669,"meanSquaredDifferenceDistance":12.81512264334755,"meanSquaredDifferenceLikesToViewsRatio":0.2649352367925832,"varianceDistance":0.256302452866951,"varianceLikesToViewsRatio":0.005298704735851664},{"age":3048,"averageDistance":0.2452195615151489,"averageLikesToViewsRatio":0.029485500328519255,"averageViews":450992.46808510623,"coordinates":[0.25022493567288706,-0.050655923762774425,0.1768350570127341,-0.09076645616879819,0.19096284464257482,0.37776340609905934,-0.3556905152879585,0.15882131255850107,-0.06136344375695214,0.2300995684396631,-0.21763800390501845,-0.01287391815976674,-21.25247376330709,-0.033189305124092884],"count":47,"countAgeRatio":0.01541994750656168,"meanSquaredDifferenceDistance":1.1166366825990188,"meanSquaredDifferenceLikesToViewsRatio":0.0036526642135848004,"varianceDistance":0.02427471049128302,"varianceLikesToViewsRatio":0.00007940574377358262},{"age":1578,"averageDistance":0.4863454401029686,"averageLikesToViewsRatio":0.02126956081922111,"averageViews":2524084.6399999997,"coordinates":[0.054738614139501214,-0.040135559204291356,0.292059962286048,-0.0807802925558748,0.18808779730305503,0.5706304541716467,0.9923470749279562,0.2300559157059852,0.34232696999599505,0.20899198640412742,-0.14371273337126328,0.0673644976707738,-4.8259532765070094,-0.031465268905260045],"count":25,"countAgeRatio":0.015842839036755388,"meanSquaredDifferenceDistance":2.3207849473106736,"meanSquaredDifferenceLikesToViewsRatio":0.006906511630863567,"varianceDistance":0.0966993728046114,"varianceLikesToViewsRatio":0.0002877713179526486},{"age":1256,"averageDistance":1.3442627463379133,"averageLikesToViewsRatio":0.10545710576216562,"averageViews":116186.39130434788,"coordinates":[0.19748744482380837,-0.05765287926719938,0.0003560814693319269,-0.09055558797370421,0.1876393673536836,-1.8023257083633322,-0.6691205898814837,0.04124304461756591,-0.11273645384055007,-0.05693420784232078,-0.17542631916522897,0.004044447574018281,-74.79980484489339,-0.03196673997740761],"count":23,"countAgeRatio":0.018312101910828025,"meanSquaredDifferenceDistance":8.793549151529364,"meanSquaredDifferenceLikesToViewsRatio":0.20035395292942812,"varianceDistance":0.3997067796149711,"varianceLikesToViewsRatio":0.009106997860428552},{"age":1245,"averageDistance":1.4146851823059416,"averageLikesToViewsRatio":0.1032445847516325,"averageViews":27206.382978723395,"coordinates":[-0.6431847578315757,-0.057074439617185606,0.037619595154660394,-0.09088660964411029,0.18758002205378307,-1.715668399137903,-0.6776157025102215,0.0867259852328593,-0.07477062512530522,-0.09544577826894267,-0.11721966476638941,-0.013614429794750606,-51.27909930578194,-0.03256705150897755],"count":47,"countAgeRatio":0.03775100401606426,"meanSquaredDifferenceDistance":27.211480330132243,"meanSquaredDifferenceLikesToViewsRatio":0.12897797071959136,"varianceDistance":0.5915539202202662,"varianceLikesToViewsRatio":0.0028038689286867687},{"age":1238,"averageDistance":0.5301189221589951,"averageLikesToViewsRatio":0.11935235641284947,"averageViews":12028.437499999998,"coordinates":[-0.09781902849037535,-0.05727629997342586,0.01602125142984214,-0.09098495794668766,0.18768429946441453,-1.6970288000578215,-0.6597663403300517,0.08436552292744692,-0.003208504133954144,0.2048147755932456,-0.16973388219689906,-0.013467051553749458,-41.09379090155268,-0.032452122365126033],"count":32,"countAgeRatio":0.025848142164781908,"meanSquaredDifferenceDistance":3.8853883236066484,"meanSquaredDifferenceLikesToViewsRatio":0.1826930045870444,"varianceDistance":0.1253351072131177,"varianceLikesToViewsRatio":0.005893322728614336},{"age":1227,"averageDistance":1.1863000538344082,"averageLikesToViewsRatio":0.09615247455080983,"averageViews":158678.7894736841,"coordinates":[-0.4916574553551767,-0.05578571522576208,0.06129139782356495,-0.09025290544552968,0.18746223900985828,-1.5333994329241718,-0.510834356453431,0.08627304130505085,-0.07620796612327715,-0.37321647626962406,-0.18458774521713425,-0.009133344989210423,-63.1344672290096,-0.029165306903510536],"count":19,"countAgeRatio":0.015484922575387123,"meanSquaredDifferenceDistance":6.74976417758139,"meanSquaredDifferenceLikesToViewsRatio":0.06114897909235753,"varianceDistance":0.3749868987545217,"varianceLikesToViewsRatio":0.003397165505130974},{"age":1048,"averageDistance":1.0088105138030607,"averageLikesToViewsRatio":0.035851324585325604,"averageViews":2133488.2921348307,"coordinates":[-2.044758751766528,-0.03796918443946859,0.07741729888051899,-0.08179006734237658,0.1872482954867519,0.2778910999232966,-0.031256077392116964,-0.15927351933572623,-0.16507607943364883,0.2078374993380956,-0.19107590527190105,0.022549551482162353,-14.714463479935059,-0.03222818765758683],"count":89,"countAgeRatio":0.08492366412213741,"meanSquaredDifferenceDistance":16.55377595626482,"meanSquaredDifferenceLikesToViewsRatio":0.03596674738227149,"varianceDistance":0.1881110904121002,"varianceLikesToViewsRatio":0.0004087130384349033},{"age":855,"averageDistance":1.2115549221780197,"averageLikesToViewsRatio":0.04184502571665818,"averageViews":64464.857142857174,"coordinates":[-3.004777743699817,-0.057652731794079246,-0.41338636644416515,-0.09001549984378368,0.1860132365695048,-0.9733150995127005,-0.41239778899381435,-1.272853343530883,-0.19021566256455746,-0.14735393092589008,-0.26732199908711785,0.1343295565552453,-3.811441616774282,0.6295732475685981],"count":28,"countAgeRatio":0.03274853801169591,"meanSquaredDifferenceDistance":14.094515340008241,"meanSquaredDifferenceLikesToViewsRatio":0.05471704853197176,"varianceDistance":0.5220190866669719,"varianceLikesToViewsRatio":0.002026557353035991},{"age":844,"averageDistance":0.7225249643600808,"averageLikesToViewsRatio":0.02721970958738448,"averageViews":8465879.724137928,"coordinates":[0.2273588450126192,-0.021942451586308594,0.3245468851542689,-0.0547920030822977,0.18656382242916095,0.7940978947972401,1.2169229857359338,-0.010911013356979565,0.028106695118652956,0.12923838392409195,-0.19973072646544882,0.4575038192634712,-9.541594400397015,-0.013054708671696585],"count":58,"countAgeRatio":0.06872037914691943,"meanSquaredDifferenceDistance":10.9510991951925,"meanSquaredDifferenceLikesToViewsRatio":0.06321815991399445,"varianceDistance":0.19212454728407893,"varianceLikesToViewsRatio":0.00110909052480692},{"age":532,"averageDistance":1.0713148130058405,"averageLikesToViewsRatio":0.043248994451628456,"averageViews":9153417.421052624,"coordinates":[0.37565100032815324,0.02956103905536661,0.2956610780200869,-0.051604975355735654,0.18628352370534196,0.3496586899767586,-0.03477118491363969,0.1612179449237463,-0.068231105249741,0.24189014670589895,-0.07329810786199212,-0.009499176244324616,-21.65251401862679,-0.032672113754073646],"count":19,"countAgeRatio":0.03571428571428571,"meanSquaredDifferenceDistance":18.13299412389103,"meanSquaredDifferenceLikesToViewsRatio":0.02690472868630774,"varianceDistance":1.0073885624383907,"varianceLikesToViewsRatio":0.0014947071492393189},{"age":525,"averageDistance":0.8306614498950363,"averageLikesToViewsRatio":0.2347748799414135,"averageViews":9007.000000000004,"coordinates":[-3.2577822473649656,-0.05786320940528458,0.00096143901490626,-0.09032226224708399,0.18625028369490274,-1.1637333176968032,-0.6709015337606969,-8.32130213682739,-0.2265006985443058,0.1018992007141048,-0.2608535184489993,-0.013910907261082402,-13.822093050456234,-0.028837357692337966],"count":9,"countAgeRatio":0.017142857142857144,"meanSquaredDifferenceDistance":1.7440508567549298,"meanSquaredDifferenceLikesToViewsRatio":0.3653929566472522,"varianceDistance":0.21800635709436622,"varianceLikesToViewsRatio":0.04567411958090652},{"age":302,"averageDistance":1.0081997177987083,"averageLikesToViewsRatio":0.04315253740857741,"averageViews":260028.5,"coordinates":[-1.483755880687937,-0.05692056092638977,0.08480319243049442,-0.08897930249887986,0.1855268674679632,-0.2701089657956779,-0.26465170163927226,-0.09942813873719962,-0.19026198957737922,-3.8606468905060494,-0.2674102617973707,0.2001685042481478,-44.45998319910054,-0.008224628132245556],"count":8,"countAgeRatio":0.026490066225165563,"meanSquaredDifferenceDistance":1.6561381608645998,"meanSquaredDifferenceLikesToViewsRatio":0.005149294956674474,"varianceDistance":0.23659116583779996,"varianceLikesToViewsRatio":0.0007356135652392106},{"age":300,"averageDistance":0,"averageLikesToViewsRatio":0.27084818246614395,"averageViews":2806.0000000000005,"coordinates":[0.26172534360442634,-0.057317444243100285,0.022208153933012623,-0.09022553522652679,0.18599174269469443,-2.0407905325724154,-0.6778301215800752,0.05087235488706973,-0.196985522012274,-5.110786815790593,-0.2679591474286347,-0.015477453037332726,-644.2197707550633,-0.03283475318761827],"count":1,"countAgeRatio":0.0033333333333333335,"meanSquaredDifferenceDistance":0,"meanSquaredDifferenceLikesToViewsRatio":0,"varianceDistance":0,"varianceLikesToViewsRatio":0},{"age":286,"averageDistance":0,"averageLikesToViewsRatio":0.004762676215263126,"averageViews":15172352.000000015,"coordinates":[0.3457466484028552,-0.05149165802171829,0.44043913569657944,-0.025895892118442714,0.18604162521851073,0.7042449004810856,-0.09225643414862274,0.31826271900926867,0.6440702153551074,0.35792617792388365,0.3673374989958607,-0.012786400667417657,-31.330530681795448,-0.032828575989261775],"count":1,"countAgeRatio":0.0034965034965034965,"meanSquaredDifferenceDistance":0,"meanSquaredDifferenceLikesToViewsRatio":0,"varianceDistance":0,"varianceLikesToViewsRatio":0},{"age":236,"averageDistance":1.725075372617175,"averageLikesToViewsRatio":0.027971507089904753,"averageViews":255081.0000000002,"coordinates":[0.27737064353942953,-0.05696933477037973,0.2414429508464133,-0.08909061400522367,0.18583212136830113,-0.06388575300030724,-0.6409631612670653,-0.06916329479744593,-0.22012226367239635,-5.10887850585134,-0.2677971349973412,-0.01564974801278731,-92.6254688560947,-0.03281124625918283],"count":2,"countAgeRatio":0.00847457627118644,"meanSquaredDifferenceDistance":5.951770082420571,"meanSquaredDifferenceLikesToViewsRatio":0,"varianceDistance":5.951770082420571,"varianceLikesToViewsRatio":0},{"age":222,"averageDistance":0.5609833078213615,"averageLikesToViewsRatio":0.1572134036403151,"averageViews":13005.333333333336,"coordinates":[-3.262522076580094,-0.05774750728439845,0.004791922101272703,-0.09000774310517046,0.18547698822350284,-1.2328752553093536,-0.6669161444130208,-8.304510069674555,-0.22625711279836566,0.04773859655777275,-0.2651395067146893,-0.014539143348848075,-5.456700767936391,-0.027628502896854604],"count":3,"countAgeRatio":0.013513513513513514,"meanSquaredDifferenceDistance":0.8823304788013195,"meanSquaredDifferenceLikesToViewsRatio":0.03185360919300241,"varianceDistance":0.44116523940065977,"varianceLikesToViewsRatio":0.015926804596501205},{"age":170,"averageDistance":0.6558294765404169,"averageLikesToViewsRatio":0.03564877755662571,"averageViews":572993,"coordinates":[0.2702246634323362,-0.05709720081002863,0.28061157666573233,-0.08769243042059557,0.18568164134976078,0.20331141607732017,-0.5811581128769715,-0.18644935376844785,-0.22503739063025302,-5.10762223937903,-0.26761698311288473,-0.015804897747191536,-68.35753995145947,-0.03279713319984354],"count":2,"countAgeRatio":0.011764705882352941,"meanSquaredDifferenceDistance":0.8602246045985544,"meanSquaredDifferenceLikesToViewsRatio":1.1195494565002721e-12,"varianceDistance":0.8602246045985544,"varianceLikesToViewsRatio":1.1195494565002721e-12},{"age":167,"averageDistance":0.6603472516445953,"averageLikesToViewsRatio":0.04247467316202782,"averageViews":510946.9999999996,"coordinates":[0.28100350095849186,-0.056726970433023056,0.27421775012682587,-0.0879520134099909,0.18567292108383865,0.17051164210525258,-0.59068336136583,-0.1509979666638273,-0.22363604805978896,-5.101597866896274,-0.2676044742642494,-0.015804208199769194,-57.65988356052966,-0.03279570112157709],"count":3,"countAgeRatio":0.017964071856287425,"meanSquaredDifferenceDistance":0.7039863172907976,"meanSquaredDifferenceLikesToViewsRatio":0.0002794958241933428,"varianceDistance":0.3519931586453988,"varianceLikesToViewsRatio":0.0001397479120966714},{"age":40,"averageDistance":0,"averageLikesToViewsRatio":0.02127659574468085,"averageViews":188,"coordinates":[0.12894877221583195,-0.05772097766493736,-0.11140077598497077,-0.09003256069595039,0.1853691739036501,-1.1589789675891442,-0.6753296302760188,-0.25577292876593555,-0.22552808033203992,-0.3459081800194066,-0.26722940468621587,0.052591177289987405,-1.1853865641249417,4.549719659791099],"count":1,"countAgeRatio":0.025,"meanSquaredDifferenceDistance":0,"meanSquaredDifferenceLikesToViewsRatio":0,"varianceDistance":0,"varianceLikesToViewsRatio":0}] 
				resolve(backup);
			}
		});
	});
	if (centroids.length == 0) {
		centroids.push(datapointDeepCopy);
	}
	return centroids;
}

async function getCoordinatesStats(datapoint) {
	let coordinatesStats = await new Promise((resolve, reject) => {
		chrome.storage.local.get(['coordinatesStats'], function (result) {
			if (result.coordinatesStats) {
				resolve(result.coordinatesStats);
			} else { // if no coordinatesStats are stored
				let backup = {"average":[-3.1430185048351023,11118.911286519244,7.522745628103937,21151462.41837333,-2.354444376837481,22.2712168458615,68848527303.6685,4.831307221436813,1838.2910119889711,8.452710985214619,4052449.39044852,13.79899082452963,-0.1385484675171785,0.00042380798205560557],"correlationMatrix":[[1,0.03198244199213832,0.4675923688126179,-0.04111943577919713,0.4154541417662531,0.14360224672817842,-0.0003705107358112896,0.28214580900645164,-0.03240096933678516,0.3599936071953928,0.04829797890983995,0.0003268240080070516,0.0015669073034858048,-0.057070488546618156],[0.03198244199213832,0.9999999999999998,0.032569456356032284,0.2640778563161365,0.011084008766600172,0.04629430311747862,0.08175593214660123,0.002172028580027198,-0.007968089245159468,0.020643730937986028,0.09297334283184447,0.012433411811709082,0.0027141244262965367,-0.0018900198847732154],[0.4675923688126179,0.032569456356032284,0.9999999999999999,0.059718570945971695,0.9734223042107901,0.015438543737755207,-0.05171375146731086,0.1431744495474579,-0.08265401836588011,0.7831693087319287,0.09610037726690067,0.006830457457518523,-0.013463947262006398,-0.013382903244735924],[-0.04111943577919713,0.2640778563161365,0.059718570945971695,1,0.0183696196626309,0.09168629600083465,0.12960043124163498,0.0030926724249359457,-0.016143644431733894,0.03341242553810603,0.14441375728500588,0.02474170742024237,0.004472346088660234,-0.002956640038443242],[0.4154541417662531,0.011084008766600172,0.9734223042107901,0.0183696196626309,1,-0.07627735059646588,-0.10858689045791607,0.1353234822852463,-0.09074971013905975,0.7893007005208842,0.047835359027764444,0.002789185289392615,-0.010394624871545376,0.006103194079484002],[0.14360224672817842,0.04629430311747862,0.015438543737755207,0.09168629600083465,-0.07627735059646588,1,0.6768217608889278,0.12316883269921373,0.04300162664863719,-0.11286525232364324,0.08525431380279824,0.013149286860411459,0.0046902971706535455,-0.003680068034911671],[-0.0003705107358112896,0.08175593214660123,-0.05171375146731086,0.12960043124163498,-0.10858689045791607,0.6768217608889278,1,0.05810186405100467,-0.013411036858512833,-0.12211916458216138,0.028655455321253697,0.017722446255745865,0.029186621118238037,0.002311587895103252],[0.28214580900645164,0.002172028580027198,0.1431744495474579,0.0030926724249359457,0.1353234822852463,0.12316883269921373,0.05810186405100467,1,0.07078352267910522,-0.030392467019937437,0.02666773153997815,0.00007244386816739682,0.006833830449322489,-0.03988025752962961],[-0.03240096933678516,-0.007968089245159468,-0.08265401836588011,-0.016143644431733894,-0.09074971013905975,0.04300162664863719,-0.013411036858512833,0.07078352267910522,1,-0.09185249749086911,-0.008287023876315837,-0.00280752677045075,0.01050094737291273,-0.00424131541061118],[0.3599936071953928,0.020643730937986028,0.7831693087319287,0.03341242553810603,0.7893007005208842,-0.11286525232364324,-0.12211916458216138,-0.030392467019937437,-0.09185249749086911,1,0.10929928243531262,-0.00028470515429007264,0.09684068221295701,-0.06977294308155742],[0.04829797890983995,0.09297334283184447,0.09610037726690067,0.14441375728500588,0.047835359027764444,0.08525431380279824,0.028655455321253697,0.02666773153997815,-0.008287023876315837,0.10929928243531262,0.9999999999999999,-0.0034662948719630772,0.013627970897128274,-0.008797155635250482],[0.0003268240080070516,0.012433411811709082,0.006830457457518523,0.02474170742024237,0.002789185289392615,0.013149286860411459,0.017722446255745865,0.00007244386816739682,-0.00280752677045075,-0.00028470515429007264,-0.0034662948719630772,0.9999999999999999,-0.0012946372263130783,0.0002626903916535609],[0.0015669073034858048,0.0027141244262965367,-0.013463947262006398,0.004472346088660234,-0.010394624871545376,0.0046902971706535455,0.029186621118238037,0.006833830449322489,0.01050094737291273,0.09684068221295701,0.013627970897128274,-0.0012946372263130783,0.9999999999999999,0.001422435032850287],[-0.057070488546618156,-0.0018900198847732154,-0.013382903244735924,-0.002956640038443242,0.006103194079484002,-0.003680068034911671,0.002311587895103252,-0.03988025752962961,-0.00424131541061118,-0.06977294308155742,-0.008797155635250482,0.0002626903916535609,0.001422435032850287,1]],"count":40288,"covarianceSum":[[35511020.72092159,7370233749.22749,11455316.208130123,-11559246922437.424,8996905.66508236,618897.2391505186,-45151486747997.96,4263187.970703967,-315108717.13414824,9166261.714688865,876427347298.7522,363125.2415228087,4628.617636346499,-878.2296411237049],[7370233749.22749,1495427553665220.2,5177871732.362806,481743087115168800,1557643423.529762,1294750158.526311,64653441112404206000,212974459.61360067,-502872301939.92456,3411039635.095897,10948295744700628,89646619344.69345,52028207.76473522,-188740.0150234304],[11455316.208130123,5177871732.362806,16900741.240886476,11581454335410.275,14542620.310312957,45902.352265427246,-4347590200164744,1492442.8119274855,-554546138.1840107,13757021.708817415,1203049103828.2507,5235565.244740115,-27437.952580573176,-142.07515453561797],[-11559246922437.424,481743087115168800,11581454335410.275,2.2253121483342267e+21,3149083162863.3735,3128064001744.5654,1.2502348397178585e+23,369920749022.01904,-1242847633016552.5,6734717139195.946,20744808105648470000,217613605906654,104582085069.87318,-360171086.4320578],[8996905.66508236,1557643423.529762,14542620.310312957,3149083162863.3735,13205856.741367264,-200472.41563680253,-8069569539426798,1246911.8610238729,-538207039.6803329,12255800.013986206,529343657493.7459,1889824.8957581355,-18724.858079631525,57.27372028294543],[618897.2391505186,1294750158.526311,45902.352265427246,3128064001744.5654,-200472.41563680253,523054.6309114972,10010079352022190,225867.45144750137,50755048.43613335,-348778.47077391023,187756626710.77716,1773113.901332011,1681.5133076831453,-6.872967593624655],[-45151486747997.96,64653441112404206000,-4347590200164744,1.2502348397178585e+23,-8069569539426798,10010079352022190,4.1818516309586936e+26,3012684661170863.5,-447576733979497700,-10670481602623250,1.7844196982622684e+21,67572328891951140,295865654875489.7,122070196713.6504],[4263187.970703967,212974459.61360067,1492442.8119274855,369920749022.01904,1246911.8610238729,225867.45144750137,3012684661170863.5,6429070.453387402,292905213.21679056,-329272.8579651931,205904364372.70367,34248.11184792507,8589.437325893527,-261.1241079535562],[-315108717.13414824,-502872301939.92456,-554546138.1840107,-1242847633016552.5,-538207039.6803329,50755048.43613335,-447576733979497700,292905213.21679056,2663366564756.154,-640504709.9276285,-41183139113342.48,-854280094.1058066,8495136.798004707,-17874.379108958557],[9166261.714688865,3411039635.095897,13757021.708817415,6734717139195.946,12255800.013986206,-348778.47077391023,-10670481602623250,-329272.8579651931,-640504709.9276285,18256659.935404483,1422110551915.8193,-226812.45624774584,205113.82163815352,-769.8615469486188],[876427347298.7522,10948295744700628,1203049103828.2507,20744808105648470000,529343657493.7459,187756626710.77716,1.7844196982622684e+21,205904364372.70367,-41183139113342.48,1422110551915.8193,9272582062981065000,-1968007533172.0632,20571121217.206036,-69176333.68378042],[363125.2415228087,89646619344.69345,5235565.244740115,217613605906654,1889824.8957581355,1773113.901332011,67572328891951140,34248.11184792507,-854280094.1058066,-226812.45624774584,-1968007533172.0632,34762503048.00209,-119654.7748004222,126.47789551918149],[4628.617636346499,52028207.76473522,-27437.952580573176,104582085069.87318,-18724.858079631525,1681.5133076831453,295865654875489.7,8589.437325893527,8495136.798004707,205113.82163815352,20571121217.206036,-119654.7748004222,245872.97598041318,1.821389218685924],[-878.2296411237049,-188740.0150234304,-142.07515453561797,-360171086.4320578,57.27372028294543,-6.872967593624655,122070196713.6504,-261.1241079535562,-17874.379108958557,-769.8615469486188,-69176333.68378042,126.47789551918149,1.821389218685924,6.668360595094688]],"meanSquaredDifference":[35511020.72092159,1495427553665220.2,16900741.240886476,2.2253121483342267e+21,13205856.741367264,523054.6309114972,4.1818516309586936e+26,6429070.453387402,2663366564756.154,18256659.935404483,9272582062981065000,34762503048.00209,245872.97598041318,6.668360595094688],"variance":[881.4729861719106,37120278847.86825,419.5189703839169,55237853058983940,327.80262973160063,12.983533508203774,1.0380409151960218e+22,159.5857234122872,66111467.128931984,453.176287926438,230168844337513.4,862892.8920220943,6.103186615211567,0.00016552550749875114]};
				resolve(backup);
			}
		});
	});
	// if any of the coordinates is NaN, set it to 0
	for (let i = 0; i < coordinatesStats.average.length; i++) {
		if (isNaN(coordinatesStats.average[i])) {
			coordinatesStats.average[i] = 0;
		}
		if (isNaN(coordinatesStats.variance[i])) {
			coordinatesStats.variance[i] = 0;
		}
		if (isNaN(coordinatesStats.meanSquaredDifference[i])) {
			coordinatesStats.meanSquaredDifference[i] = 0;
		}
	}

	return coordinatesStats;
}
// #endregion

function clog(/* arguments */) {
	let prefix = "[Youtube-Video-Stats] ";
	let args = Array.prototype.slice.call(arguments);
	if (typeof args[0] == "string") {
		args[0] = prefix + args[0];
	} else {
		args.unshift(prefix);
	}
	console.log.apply(console, args);
}

async function getVideoInfo(videoId) {
	const url = `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${API_KEY}&part=statistics,contentDetails,snippet`;
	const response = await fetch(url);
	const data = await response.json();
	let commentCount = data.items[0].statistics.commentCount;
	let viewCount = data.items[0].statistics.viewCount ? data.items[0].statistics.viewCount : -100;
	let likeCount = data.items[0].statistics.likeCount;
	let publishedAt = data.items[0].snippet.publishedAt
	let duration = data.items[0].contentDetails.duration;
	let channelId = data.items[0].snippet.channelId;
	let channelUrl = `https://www.googleapis.com/youtube/v3/channels?id=${channelId}&key=${API_KEY}&part=statistics`;
	const response2 = await fetch(channelUrl);
	const data2 = await response2.json();
	let subscriberCount = data2.items[0].statistics.subscriberCount;
	let videoAge = getVideoAge(publishedAt);
	let durationSeconds = getDurationSeconds(duration);
	return {
		"commentCount": commentCount ? commentCount : -100,
		"viewCount": viewCount,
		"likeCount": likeCount,
		"videoAge": videoAge,
		"duration": durationSeconds,
		"subscriberCount": subscriberCount
	};
}

function getVideoAge(publishedAt) {
	let videoAge = Date.now() - new Date(publishedAt).getTime();
	return videoAge;
}

function getDurationSeconds(duration) {
	if (duration == "P0D") {
		return -100;
	} else {
		var a = duration.match(/P(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?)?/);
		var days = a[1] ? parseInt(a[1]) : 0;
		var hours = a[2] ? parseInt(a[2]) : 0;
		var minutes = a[3] ? parseInt(a[3]) : 0;
		var seconds = a[4] ? parseInt(a[4]) : 0;
		return (days * 24 * 60 * 60) + (hours * 60 * 60) + (minutes * 60) + seconds;
	}
}

function removeCorruptedCentroids(centroids) {
	centroids.forEach(function (centroid) {
		for (let key in centroid) {
			if (Array.isArray(centroid[key])) {
				if (centroid[key].includes(NaN) || centroid[key].includes(undefined) || centroid[key].includes(null)) {
					if (clogCorruptedCentroids) {
						clog("Corrupted centroid found: ", key, " is ", centroid[key]);
					}
					centroids.splice(centroids.indexOf(centroid), 1);
				}
			} else {
				if (isNaN(centroid[key]) || centroid[key] == undefined || centroid[key] == null) {
					if (clogCorruptedCentroids) {
						clog("Corrupted centroid found: ", key, " is ", centroid[key]);
					}
					centroids.splice(centroids.indexOf(centroid), 1);
				}
			}
		}
	});
	return centroids;
}

function removeObsoleteCentroids(centroids) {
	let countAgeRatioAverage = 0;
	centroids.forEach(function (centroid) {
		countAgeRatioAverage += Math.log10(centroid.countAgeRatio);
	});
	countAgeRatioAverage = countAgeRatioAverage / centroids.length;
	let countAgeRatioStandardDeviation = 0;
	centroids.forEach(function (centroid) {
		countAgeRatioStandardDeviation += Math.pow(Math.log10(centroid.countAgeRatio) - countAgeRatioAverage, 2);
	});
	countAgeRatioStandardDeviation = Math.sqrt(countAgeRatioStandardDeviation / centroids.length);
	countAgeRatioStandardDeviation = countAgeRatioStandardDeviation == 0 ? Math.log10(Math.sqrt(Math.pow(10, countAgeRatioAverage))) : countAgeRatioStandardDeviation;
	centroids.forEach(function (centroid) {
		let percentile = (1 + erf((Math.log10(centroid.countAgeRatio) - countAgeRatioAverage) / (countAgeRatioStandardDeviation * Math.sqrt(2)))) / 2;
		if (centroid.age > 300) {
			if (percentile <= 0.32 && centroid.count <= 3) {
				centroids.splice(centroids.indexOf(centroid), 1);
				clog("Obsolete centroid found");
			} else if (percentile <= 0.20 && centroid.count <= 10) {
				centroids.splice(centroids.indexOf(centroid), 1);
				clog("Obsolete centroid found");
			} else if (percentile <= 0.13 && centroid.count <= 30) {
				centroids.splice(centroids.indexOf(centroid), 1);
				clog("Obsolete centroid found");
			} else if (percentile <= 0.08 && centroid.count <= 100) {
				centroids.splice(centroids.indexOf(centroid), 1);
				clog("Obsolete centroid found");
			} else if (percentile <= 0.05) {
				centroids.splice(centroids.indexOf(centroid), 1);
				clog("Obsolete centroid found");
			}
		}
	});
	return centroids;
}

function saveCentroids(centroids) {
	centroids = removeCorruptedCentroids(centroids);
	centroids.forEach(function (centroid) {
		centroid.age++;
		centroid.countAgeRatio = centroid.count / centroid.age;
	});
	centroids = removeObsoleteCentroids(centroids);
	if (clogCentroids) {
		clog("centroids", centroids);
	}
	// save centroids to chrome storage
	chrome.storage.local.set({
		'centroids': centroids, function() {
			if (chrome.runtime.lastError) {
				let smallestCountAgeRatio = Math.min(...centroids.map(centroid => centroid.countAgeRatio));
				let smallestCountAgeRatioIndex = centroids.findIndex(centroid => centroid.countAgeRatio == smallestCountAgeRatio);
				let averageDistance = centroids[smallestCountAgeRatioIndex].averageDistance;
				let remainingCentroids = centroids.splice(smallestCountAgeRatioIndex, 1);
				remainingCentroids.forEach(function (centroid) {
					centroid.averageDistance += averageDistance / remainingCentroids.length;
				});
				centroids.splice(smallestCountAgeRatioIndex, 1);
				chrome.storage.local.set({
					'centroids': centroids, function() {
						if (chrome.runtime.lastError) {
							clog("Error saving centroids to chrome storage");
						}
					}
				});
			} else {
				clog("Centroids saved to chrome storage");
			}
		}
	});
	if (exportVariables) {
		exportObjectToLocalFolder(centroids, "centroids") // EXPORT
	}
}

function exportObjectToLocalFolder(object, objectName) {
	let json = JSON.stringify(object);
	let blob = new Blob([json], { type: "application/json" });
	let url = window.URL.createObjectURL(blob);
	let a = document.createElement('a');
	a.href = url;
	a.download = objectName + ".json";
	a.click();
	window.URL.revokeObjectURL(url);
}

function calculateDistanceWeights(covarianceMatrix) {
	let distanceWeights = Array(covarianceMatrix.length).fill(0);
	let numberOfCoordinates = covarianceMatrix.length;
	for (let i = 0; i < covarianceMatrix.length; i++) {
		// get max value excluding diagonal
		let maxValue = 0;
		for (let j = 0; j < covarianceMatrix[i].length; j++) {
			let value = Math.abs(covarianceMatrix[i][j]);
			if (i != j && value > maxValue) {
				distanceWeights[i] = value;
				maxValue = value;
			}
		}
		distanceWeights[i] = 1 / numberOfCoordinates + (1 - distanceWeights[i]) * (numberOfCoordinates - 1) / numberOfCoordinates;
	}
	if (clogDistanceWeights) {
		clog("Distance weights: ", distanceWeights);
	}
	return distanceWeights;
}

function sequentialKMeans(centroids, datapoint, covarianceMatrix) {
	let thresholds = [];
	let distances = [];
	let distancesMinusThreshold = [];
	let minDistance = 9999;
	let distanceWeights = calculateDistanceWeights(covarianceMatrix);
	// find minimum distance between datapoint and centroids
	centroids.forEach(function (centroid) {
		let distance = getEuclideanDistance(centroid.coordinates, datapoint.coordinates, distanceWeights);
		distances.push(distance);
		let avgDist = centroid.averageDistance == 0 ? distance / 3 : centroid.averageDistance;
		let multiplier = centroid.age < 100 ? 1 : (centroid.age < 300 ? (centroid.age - 100) / (300 - 100) * (0.75 - 1) + 1 : (centroid.age < 1000 ? (centroid.age - 300) / (1000 - 300) * (0.5 - 0.75) + 0.75 : (centroid.age < 3000 ? (centroid.age - 1000) / (3000 - 1000) * (0.25 - 0.5) + 0.5 : (centroid.age < 10000 ? 0.25 : (centroid.age < 30000 ? (centroid.age - 10000) / (30000 - 10000) * (0.5 - 0.25) + 0.25 : (centroid.age < 100000 ? (centroid.age - 30000) / (100000 - 30000) * (0.75 - 0.5) + 0.5 : 0.75))))));
		let varDist = centroid.varianceDistance == 0 ? Math.sqrt(distance) : centroid.varianceDistance;
		let stdDist = Math.sqrt(varDist) > multiplier * 4 ? (centroid.age > 10000 ? 1 : multiplier * 4) : Math.sqrt(varDist);
		let threshold = (avgDist + 2 * stdDist) * multiplier;
		thresholds.push(threshold);
		let distanceMinusThreshold = distance - threshold;
		distancesMinusThreshold.push(distanceMinusThreshold);
		if (distanceMinusThreshold <= 0 && distance < minDistance) {
			minDistance = distance;
		}
	});
	let index = distances.indexOf(minDistance);
	if (minDistance == 9999) {
		if (clogClusteringInfo) {
			clog("Min distance is greater than threshold");
			clog("Creating new centroid");
		}
		centroids.push(datapoint);
		index = centroids.length - 1;
	} else {
		if (clogClusteringInfo) {
			clog("Datapoint clustered to centroid with index ", index);
		}
		centroids[index] = updateCentroid(centroids[index], datapoint, minDistance);
	}
	let centroidsCopy = JSON.parse(JSON.stringify(centroids));
	saveCentroids(centroidsCopy);
	return centroids[index];
}

function updateCentroid(centroid, datapoint, distance) {
	centroid.count += 1;
	// update centroid coordinates
	let coordinates = centroid.coordinates;
	let newCoordinates = [];
	for (let i = 0; i < coordinates.length; i++) {
		let newCoordinateStats = movingAverageAndVariance(centroid.count, coordinates[i], 0, datapoint.coordinates[i]);
		newCoordinates.push(newCoordinateStats.average);
	}
	centroid.coordinates = newCoordinates;
	// Update distance stats
	let newDistanceStats = movingAverageAndVariance(centroid.count, centroid.averageDistance, centroid.meanSquaredDifferenceDistance, distance);
	centroid.averageDistance = newDistanceStats.average;
	centroid.varianceDistance = newDistanceStats.variance;
	centroid.meanSquaredDifferenceDistance = newDistanceStats.meanSquaredDifference;
	// update likes to views ratio stats 
	let newLikesToViewsRatioStats = movingAverageAndVariance(centroid.count, centroid.averageLikesToViewsRatio, centroid.meanSquaredDifferenceLikesToViewsRatio, datapoint.averageLikesToViewsRatio);
	centroid.averageLikesToViewsRatio = newLikesToViewsRatioStats.average;
	centroid.varianceLikesToViewsRatio = newLikesToViewsRatioStats.variance;
	centroid.meanSquaredDifferenceLikesToViewsRatio = newLikesToViewsRatioStats.meanSquaredDifference;
	// update age stats
	let newViewsStats = movingAverageAndVariance(centroid.count, centroid.averageViews, 0, datapoint.averageViews);
	centroid.averageViews = newViewsStats.average;
	return centroid;
}

function movingAverageAndVariance(count, average, meanSquaredDifference, newValue) {
	stats = {
		"average": average,
		"meanSquaredDifference": meanSquaredDifference,
		"variance": 0
	};
	let delta = newValue - stats.average;
	stats.average += delta / count;
	let delta2 = newValue - stats.average;
	stats.meanSquaredDifference += delta * delta2;
	stats.variance = stats.meanSquaredDifference / (count == 1 ? 1 : (count - 1));
	return stats;
}

function movingCovariance(x, y, xAverage, yAverage, count, covarianceSum) {
	stats = {
		"covarianceSample": 0,
		"covarianceSum": covarianceSum,
	}
	let xDiff = x - xAverage;
	xAverage += xDiff / count;
	yAverage += (y - yAverage) / count;
	stats.covarianceSum += xDiff * (y - yAverage);
	stats.covarianceSample = stats.covarianceSum / (count == 1 ? 1 : (count - 1));
	return stats;
}

function getEuclideanDistance(coordinates1, coordinates2, weights) {
	let distance = 0;
	let weightSum = 0;
	for (let i = 0; i < coordinates1.length; i++) {
		distance += Math.pow(coordinates1[i] - coordinates2[i], 2) * weights[i];
		weightSum += weights[i];
	}
	distance = distance / weightSum;
	return Math.sqrt(distance);
}

function calculateScore(centroid, datapoint) {
	let mu = centroid.averageLikesToViewsRatio;
	let variance = centroid.varianceLikesToViewsRatio == 0 ? Math.abs(centroid.averageLikesToViewsRatio) : centroid.varianceLikesToViewsRatio;
	let sigma = Math.sqrt(variance);
	let value = (datapoint.averageLikesToViewsRatio * datapoint.averageViews + centroid.averageLikesToViewsRatio * centroid.averageViews) / (datapoint.averageViews + centroid.averageViews);
	let adjSigma = sigma * Math.pow(datapoint.averageViews / (datapoint.averageViews + centroid.averageViews), 1 / 2);
	let percentile = (1 + erf((value - mu) / (adjSigma * Math.sqrt(2)))) / 2;
	let dislike = 1 - percentile;
	let dislikeVar = Math.abs(dislike - 0.5);
	let normDislikeVar = dislikeVar / 0.229167;
	normDislikeVar = dislike < 0.5 ? -normDislikeVar : normDislikeVar;
	let avg = -1.2;
	let std = 0.55;
	let normDislike = normDislikeVar * std + avg;
	let newDislike = Math.pow(10, normDislike);
	let score = 1 - newDislike;
	score = score / 0.996;
	score = score < 0 ? 0 : score;
	score = score > 1 ? 1 : score;
	return score
}

function erf(x) {
	let sign = (x >= 0) ? 1 : -1;
	x = Math.abs(x);
	let a1 = 0.254829592;
	let a2 = -0.284496736;
	let a3 = 1.421413741;
	let a4 = -1.453152027;
	let a5 = 1.061405429;
	let p = 0.3275911;
	let t = 1.0 / (1.0 + p * x);
	let y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
	return sign * y;
}


function normalizeCoordinates(datapoint, coordinatesStats) {
	let normalizedCoordinates = [];
	for (let i = 0; i < coordinatesStats.average.length; i++) {
		let standardizedCoordinate = datapoint.coordinates[i] - coordinatesStats.average[i];
		stdev = coordinatesStats.variance[i] == 0 ? 1 : Math.sqrt(coordinatesStats.variance[i]);
		normalizedCoordinates.push(standardizedCoordinate / stdev);
	}
	return normalizedCoordinates;
}

function updateAndSaveCoordinateStats(coordinatesStats, datapoint, normalizedCoordinates) {
	for (let i = 0; i < coordinatesStats.average.length; i++) {
		// coordinates stats
		let updatedStats = movingAverageAndVariance(
			coordinatesStats.count, coordinatesStats.average[i],
			coordinatesStats.meanSquaredDifference[i], datapoint.coordinates[i]
		);
		coordinatesStats.variance[i] = updatedStats.variance;
		coordinatesStats.meanSquaredDifference[i] = updatedStats.meanSquaredDifference;
		// covariance stats
		if (coordinatesStats.count > 1) {
			let covarianceStats = {};
			for (let j = i; j < coordinatesStats.average.length; j++) {
				covarianceStats = movingCovariance(
					datapoint.coordinates[i], datapoint.coordinates[j],
					coordinatesStats.average[i], coordinatesStats.average[j],
					coordinatesStats.count, coordinatesStats.covarianceSum[i][j]
				);
				coordinatesStats.correlationMatrix[i][j] = covarianceStats.covarianceSample / (Math.sqrt(coordinatesStats.variance[i]) * Math.sqrt(coordinatesStats.variance[j]));
				coordinatesStats.correlationMatrix[i][j] = coordinatesStats.correlationMatrix[i][j] > 1 ? 1 : coordinatesStats.correlationMatrix[i][j];
				coordinatesStats.correlationMatrix[i][j] = coordinatesStats.correlationMatrix[i][j] < -1 ? -1 : coordinatesStats.correlationMatrix[i][j];
				coordinatesStats.correlationMatrix[j][i] = coordinatesStats.correlationMatrix[i][j];
				coordinatesStats.covarianceSum[i][j] = covarianceStats.covarianceSum;
				coordinatesStats.covarianceSum[j][i] = coordinatesStats.covarianceSum[i][j];
			}
		}
		coordinatesStats.average[i] = updatedStats.average;
	}
	coordinatesStats.count++;
	chrome.storage.local.set({ coordinatesStats: coordinatesStats });
	if (clogCoordinateStats) {
		clog("coordinatesStats", coordinatesStats);
	}
	if (exportVariables) {
		exportObjectToLocalFolder(coordinatesStats, "coordinatesStats"); 
	}
	return coordinatesStats;
}

// initialize datapoint
async function initializeDatapoint(videoData) {
	let videoDataLog = {
		"commentCount": (videoData.commentCount == undefined || isNaN(videoData.commentCount) || videoData.commentCount <= 1) ? -100 : Math.log(videoData.commentCount),
		"viewCount": (videoData.viewCount == undefined || isNaN(videoData.viewCount) || videoData.viewCount <= 1) ? -100 : Math.log(videoData.viewCount),
		"videoAge": (videoData.videoAge == undefined || isNaN(videoData.videoAge) || videoData.videoAge <= 1) ? -100 : Math.log(videoData.videoAge),
		"duration": (videoData.duration == undefined || isNaN(videoData.duration) || videoData.duration <= 1) ? -100 : Math.log(videoData.duration),
		"subscriberCount": (videoData.subscriberCount == undefined || isNaN(videoData.subscriberCount) || videoData.subscriberCount <= 1) ? -100 : Math.log(videoData.subscriberCount),
		"subscriberViewCountRatio": (videoData.viewCount / videoData.subscriberCount == undefined || isNaN(videoData.viewCount / videoData.subscriberCount) || videoData.viewCount / videoData.subscriberCount == null) ? -1 : videoData.viewCount / videoData.subscriberCount,
		"subscriberViewCountRatio2": Math.log(videoData.viewCount / (videoData.subscriberCount + videoData.viewCount)) == undefined || isNaN(Math.log(videoData.viewCount / (videoData.subscriberCount + videoData.viewCount))) || Math.log(videoData.viewCount / (videoData.subscriberCount + videoData.viewCount)) == null ? -100 : Math.log(videoData.viewCount / (videoData.subscriberCount + videoData.viewCount))
	};
	let datapoint = {
		"coordinates": [
			/*0*/ videoDataLog.commentCount,
			/*1*/ Math.exp(videoDataLog.commentCount),
			/*2*/ videoDataLog.viewCount,
			/*3*/ (videoData.viewCount == undefined || isNaN(videoData.viewCount) || videoData.viewCount < 1) ? -100 : videoData.viewCount * 1,
			/*4*/ (videoData.viewCount == undefined || isNaN(videoData.viewCount) || videoData.viewCount < 1) ? -100 : Math.exp(videoData.viewCount / 1e10),
			/*5*/ videoDataLog.videoAge,
			/*6*/ Math.exp(videoDataLog.videoAge),
			/*7*/ videoDataLog.duration,
			/*8*/ Math.exp(videoDataLog.duration),
			/*9*/ videoDataLog.subscriberCount,
			/*10*/ Math.exp(videoDataLog.subscriberCount),
			/*11*/ videoDataLog.subscriberViewCountRatio,
			/*12*/ videoDataLog.subscriberViewCountRatio2,
			/*13*/ Math.exp(videoDataLog.subscriberViewCountRatio2)
		],
		"averageLikesToViewsRatio": videoData.likeCount * 1.0 / (Math.exp(videoDataLog.viewCount) < 1 ? 1 : Math.exp(videoDataLog.viewCount)),
		"varianceLikesToViewsRatio": 0,
		"averageViews": Math.exp(videoDataLog.viewCount) < 1 ? 1 : Math.exp(videoDataLog.viewCount),
		"averageDistance": 0,
		"varianceDistance": 0,
		"count": 1,
		"age": 0,
		"countAgeRatio": 0,
		"meanSquaredDifferenceDistance": 0,
		"meanSquaredDifferenceLikesToViewsRatio": 0
	};
	return datapoint;
}

function getScoreColor(score) {
	let scoreColor = (score - 40) / (60) * 255;
	let lightDark = (score - 50) / 50 * 255 * 0.4 - 10;
	let red = Math.abs(scoreColor - 255) + lightDark;
	let blue = score > 95 ? (score - 97) / 3 * 255 + lightDark : lightDark;
	let green = 255 - red + lightDark;
	red = red > 255 ? 255 : red;
	green = green > 255 ? 255 : green;
	blue = blue > 255 ? 255 : blue;
	return [red, green, blue];
}	

function displayScore(score, isThumbnail, thumbnail, isNormalVideo, isShorts, isMobile, videoId) {
	score = (score * 100).toFixed(1);
	let color = getScoreColor(score);
	if (!isThumbnail && !isMobile) {
		// create score element
		let scoreElement = document.createElement("div");
		scoreElement.className = "scoreElement";
		scoreElement.style['display'] = "flex";
		scoreElement.style['align-items'] = "center";
		scoreElement.style['justify-content'] = "center";
		scoreElement.style['background-color'] = `rgb(${color[0]*3/4+128/4}, ${color[1]*3/4+128/4}, ${color[2]*3/4+128/4})`;
		scoreElement.style['color'] = 'var(--yt-button-icon-button-text-color,var(--yt-spec-text-secondary))';
		scoreElement.style['border-radius'] = "5px";
		scoreElement.style['border'] = "2px solid ";
		scoreElement.style['font-size'] = 'var(--ytd-tab-system-font-size)';
		scoreElement.style['font-family'] = 'Roboto, Arial, sans-serif';
		scoreElement.style['font-weight'] = 'var(--ytd-tab-system-font-weight)';
		scoreElement.style['letter-spacing'] = 'var(--ytd-tab-system-letter-spacing)';
		scoreElement.style['padding'] = '1px 4px 1px 6px';
		scoreElement.innerHTML = `${score}%`;
		if (isShorts) {
			scoreElement.style['margin'] = 'var(--yt-button-padding,0.7em 0.57em)' 
			scoreElement.style['height'] = 'var(--iron-icon-height,24px)';
			scoreElement.style['width'] = 'var(--iron-icon-width,24px)';

			// get all elements with id="player-container"
			let playerContainers = document.querySelectorAll("#player-container");
			let playerContainer
			let playerContainerFound = false;
			for (let i = 0; i < playerContainers.length; i++) {
				playerContainer = playerContainers[i];
				let backgroundImage = playerContainer.style['background-image'];
				if (backgroundImage.includes(videoId)) {
					playerContainerFound = true;
					break;
				}
			}
			let buttonMenuElement
			if (playerContainerFound) {
				let playerContainerParent = playerContainer.parentElement;
				buttonMenuElement = playerContainerParent.querySelector("div#like-button");
			} else {
				buttonMenuElement = document.querySelector("div#like-button");
			}

			if (buttonMenuElement.querySelector(".scoreElement") == null) {
				buttonMenuElement.insertBefore(scoreElement, buttonMenuElement.firstChild);
			}
		} else if (isNormalVideo) {
			scoreElement.style['margin'] = '7px 13px 9px 0px';
			let buttonMenuElement = document.getElementById("top-level-buttons-computed");
			buttonMenuElement.insertBefore(scoreElement, buttonMenuElement.firstChild);
		} 
	}	
	if (isThumbnail) { 
		let div = document.createElement('div');
		div.style['position'] = 'absolute';
		div.style['top'] = '0';
		div.style['left'] = '0';
		div.style['background-color'] = '#fff';
		div.style['font-size'] = '12px';
		div.style['padding'] = '0.2em 0.4em';
		div.style['border-radius'] = '0.2em';
		div.style['font-weight'] = 'bold';
		div.classList.add("scoreExtension");
		div.innerHTML = `<span>${score}%</span>`;
		div.style['color'] = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
		thumbnail.append(div);
	}
}

async function main(videoId, isThumbnail = false, thumbnail = null) {
	let videoData = await getVideoInfo(videoId);
	if (videoData.likeCount == undefined || videoData == null) {
		return null;
	}
	let datapoint = await initializeDatapoint(videoData);
	coordinatesStats = await getCoordinatesStats(datapoint);
	let normalizedCoordinates = normalizeCoordinates(datapoint, coordinatesStats);
	coordinatesStats = updateAndSaveCoordinateStats(coordinatesStats, datapoint, normalizedCoordinates);
	datapoint.coordinates = normalizedCoordinates;
	let centroids = await getCentroids(datapoint);
	let centroid = sequentialKMeans(centroids, datapoint, coordinatesStats.correlationMatrix);
	let videoScore = calculateScore(centroid, datapoint);
	displayScore(videoScore, isThumbnail, thumbnail, isNormalVideo(), isShorts(), isMobile, videoId);
}

// #region wait to get video id
function getVideoId() {
	const urlObject = new URL(window.location.href);
	const pathname = urlObject.pathname;
	if (pathname.startsWith("/clip")) {
		return document.querySelector("meta[itemprop='videoId']").content;
	} else {
		if (pathname.startsWith("/shorts")) {
			return pathname.slice(8);
		}
		return urlObject.searchParams.get("v");
	}
}

function isVideoLoaded() {
	if (isMobile) {
		return document.getElementById("player").getAttribute("loading") == "false";
	}
	const videoId = getVideoId();
	return (
		document.querySelector(`ytd-watch-flexy[video-id='${videoId}']`) !== null
	);
}

async function waitForVideoToLoad(event) {
	let loadTimer;
	function checkForVideoLoad(check) {
		if (isShorts() || isVideoLoaded()) {
			clearInterval(loadTimer);
			let videoId = getVideoId();
			main(videoId);
		} else {
			clog("Video loading...");
		}
	}
	loadTimer = setInterval(checkForVideoLoad, 111);
}
// #endregion

// #region Start here
(async function () {
	try {
		if (isShorts() || isNormalVideo()) {
			window.addEventListener("yt-navigate-finish", waitForVideoToLoad, true);
		}
	} catch (err) {
		clog(err);
	}
})();
// #endregion

// #region Thumbnail Scores Button
chrome.runtime.onMessage.addListener(gotMessage);
async function gotMessage(message, sender, sendResponse) {
	if (message.txt == "getScores") {
		getThumbnailScores();
	}
}

async function getThumbnailScores() {
	let thumbnails = document.querySelectorAll("ytd-thumbnail");
	for (let i = 0; i < thumbnails.length; i++) {
		let thumbnail = thumbnails[i];
		let a = thumbnail.querySelector("a");
		let href = a.getAttribute("href");
		if (href != null) {
			let videoId
			if (href.includes("/shorts/")) {
				videoId = href.split("/shorts/")[1].split("/")[0];
			} else {
				videoId = href.split("=")[1];
			}
			if (clogVideoIds) {
				clog("videoId: ", videoId);
			}
			let score = await main(videoId, true, thumbnail);

		}
	}
}
// #endregion